<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <title>Stream Together {% if is_admin %}- Admin Control{% endif %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root { --glow-color: rgb(168, 85, 247); }
        body { background-color: #000000; font-family: 'Roboto', sans-serif; }
        #dynamic-background { position: fixed; inset: 0; z-index: -2; background-image: radial-gradient(at 20% 20%, hsla(273, 91%, 60%, 0.2) 0px, transparent 50%), radial-gradient(at 80% 20%, hsla(193, 91%, 60%, 0.2) 0px, transparent 50%); transition: background-image 1.5s ease-in-out; }
        .spline-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.4; }
        #player { border-radius: 1rem; box-shadow: 0px 30px 60px -15px rgba(0, 0, 0, 0.8), inset 0 0 15px rgba(168, 85, 247, 0.2); }
        .input-field:focus { box-shadow: 0 0 15px 2px rgba(168, 85, 247, 0.5), inset 0 2px 4px 0 rgba(0,0,0,0.5); border-color: var(--glow-color) !important; }
        .action-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(168, 85, 247, 0.4); }
        #chat-messages::-webkit-scrollbar, #user-list::-webkit-scrollbar, #queue-list::-webkit-scrollbar { width: 8px; }
        #chat-messages::-webkit-scrollbar-track, #user-list::-webkit-scrollbar-track, #queue-list::-webkit-scrollbar-track { background: #1f2937; border-radius: 10px;}
        #chat-messages::-webkit-scrollbar-thumb, #user-list::-webkit-scrollbar-thumb, #queue-list::-webkit-scrollbar-thumb { background: var(--glow-color); border-radius: 10px; }
        #volume-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #a855f7; cursor: pointer; border-radius: 50%; }
        #name-modal-overlay.visible { display: flex; }
        #name-modal-overlay.visible #name-modal-content { transform: scale(1); opacity: 1; }
    </style>
</head>
<body class="text-white h-screen p-4 overflow-hidden">

    <div id="dynamic-background"></div>
    <div class="spline-container"><iframe src='https://my.spline.design/interdimensionalmessaged-6c5b9f71c172d7f57134376c7c4f45d3/' frameborder='0' width='100%' height='100%'></iframe></div>
    
    <div id="name-modal-overlay" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[100] hidden">
        <div id="name-modal-content" class="bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700 w-full max-w-sm transform scale-95 opacity-0 transition-all duration-300">
            <h2 class="text-2xl font-bold text-purple-400 mb-4 text-center">Welcome!</h2>
            <p class="text-gray-300 mb-6 text-center">Please enter your name to join the room.</p>
            <form id="name-form">
                <input type="text" id="name-input" class="input-field w-full bg-gray-900/70 border-2 border-gray-600 focus:border-purple-500 rounded-lg py-3 px-4 outline-none" placeholder="Your Name" required minlength="2" maxlength="20">
                <p id="name-error" class="text-red-400 text-sm mt-2 h-5"></p>
                <button type="submit" class="action-button w-full bg-purple-600 hover:bg-purple-700 font-bold py-3 px-8 rounded-lg mt-4">Join Room</button>
            </form>
        </div>
    </div>

    {% if not is_admin %}
    <div id="waiting-overlay" class="fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center z-50"><h2 class="text-3xl font-bold text-purple-400 mb-4">Awaiting Admin Approval</h2><p class="text-gray-300">Your request to join has been sent. Please wait...</p></div>
    {% endif %}

    <main class="w-full max-w-7xl mx-auto h-full grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6 relative z-10 grid-rows-1">
        
        <div class="lg:col-span-2 bg-gray-900/50 backdrop-blur-md border border-gray-800 rounded-2xl p-4 sm:p-6 space-y-4 h-full">
            <header class="text-center relative">
                <div class="flex items-center justify-center gap-3 flex-wrap">
                    <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold tracking-wider font-['Orbitron']">Room: <span id="room-id-text">{{ room_id }}</span></h1>
                    <button id="copy-room-id-btn" title="Copy Room ID" class="p-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375-3.75-3.75m3.75 3.75 3.75-3.75m-7.5-3.75h.008v.008h-.008v-.008Z" />
                        </svg>
                    </button>
                    <span id="copy-feedback" class="text-green-400 font-semibold text-sm opacity-0 transition-opacity duration-300">Copied!</span>
                </div>
                <p class="text-md text-gray-400 mt-1">{% if is_admin %}You are the <span class="text-purple-400 font-bold">Admin</span>.{% else %}You are a <span class="text-blue-400 font-bold">Viewer</span>.{% endif %}</p>
                
                {% if not is_admin %}
                <div class="absolute top-0 right-0 flex gap-2">
                    <button id="change-name-btn" title="Change Name" class="action-button text-xs bg-gray-700 hover:bg-gray-600 font-bold py-2 px-3 rounded-lg transition-all">Change Name</button>
                    <button id="leave-room-btn" title="Leave Room" class="action-button text-xs bg-red-800 hover:bg-red-700 font-bold py-2 px-3 rounded-lg transition-all">Leave</button>
                </div>
                {% endif %}
            </header>

            <div id="player-wrapper" class="aspect-video w-full bg-black rounded-lg overflow-hidden relative flex-shrink-0">
                <div id="player" class="w-full h-full"></div>
                {% if not is_admin %}
                <div class="absolute top-2 right-2 z-20"><button id="fullscreen-btn" title="Toggle Fullscreen" class="p-2 bg-black bg-opacity-40 rounded-full hover:bg-opacity-75 transition-opacity opacity-60 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-white"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m4.5 11.25h-4.5m4.5 0v-4.5m0 0L15 15" /></svg></button></div>
                <div id="volume-controls" class="absolute bottom-2 left-2 z-20 flex items-center gap-2 p-1.5 pr-3 bg-black bg-opacity-40 rounded-full transition-opacity opacity-60 hover:opacity-100"><button id="mute-btn" title="Mute/Unmute" class="p-1"><svg id="volume-on-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-white"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" /></svg><svg id="volume-off-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-white hidden"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6.375a9 9 0 0 1 12.728 0M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" /></svg></button><input id="volume-slider" type="range" min="0" max="100" value="100" class="w-24 h-1 accent-purple-500 bg-gray-600 rounded-lg appearance-none cursor-pointer"></div>
                {% endif %}
            </div>

            <div class="flex flex-col sm:flex-row gap-4 items-center flex-wrap">
                <div class="relative flex-grow w-full min-w-0"><input type="text" id="youtube-url" class="input-field w-full bg-gray-800/70 border-2 border-gray-600 focus:border-purple-500 rounded-lg py-3 pr-3 pl-4 outline-none" placeholder="Paste a YouTube URL..."></div>
                <button id="add-to-queue-btn" class="action-button flex-shrink-0 bg-green-600 hover:bg-green-700 font-bold py-3 px-6 rounded-lg transition-all">Add to Queue</button>
                {% if is_admin %}
                <button id="play-immediately-btn" class="action-button flex-shrink-0 bg-purple-600 hover:bg-purple-700 font-bold py-3 px-6 rounded-lg transition-all">Play Now</button>
                <button id="end-room-btn" class="action-button flex-shrink-0 bg-red-800 hover:bg-red-700 font-bold py-3 px-6 rounded-lg transition-all">End Room</button>
                {% endif %}
            </div>
        </div>
        
        <div class="lg:col-span-1 bg-gray-900/50 backdrop-blur-md border border-gray-800 rounded-2xl p-4 sm:p-6 flex flex-col h-full min-h-0">
            <div id="participant-panel"><h3 class="text-xl font-bold text-purple-400 border-b-2 border-gray-700 pb-2 mb-3">Participants (<span id="participant-count">0</span>)</h3><div id="user-list" class="space-y-2 mb-2 max-h-24 lg:max-h-32 xl:max-h-40 overflow-y-auto"></div></div>
            <div id="now-playing-panel"><h3 class="text-xl font-bold text-green-400 border-b-2 border-gray-700 pb-2 mb-3">Now Playing</h3><div id="now-playing-card" class="mb-4"></div></div>
            <div id="queue-panel"><h3 class="text-xl font-bold text-purple-400 border-b-2 border-gray-700 pb-2 mb-3">Up Next</h3><div id="queue-list" class="space-y-2 mb-4 max-h-32 lg:max-h-48 xl:max-h-56 overflow-y-auto"></div></div>
            <h3 class="text-xl font-bold text-purple-400 border-b-2 border-gray-700 pb-2 mb-3">Live Chat</h3>
            <div id="chat-messages" class="flex-1 space-y-3 overflow-y-auto pr-2 mb-4 min-h-0"></div>
            <div class="flex gap-2 mt-auto flex-shrink-0">
                <div class="relative flex-grow">
                    <input type="text" id="chat-input" placeholder="Type a message..." class="input-field w-full bg-gray-800/70 border-2 border-gray-600 rounded-lg py-2 pl-3 pr-12 outline-none">
                    <button id="emoji-btn" title="Add emoji" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-purple-400 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.182 15.182a4.5 4.5 0 0 1-6.364 0M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0ZM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75s.168-.75.375-.75.375.336.375.75Zm4.5 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75Z" /></svg>
                    </button>
                    <div id="emoji-picker" class="hidden absolute bottom-full right-0 mb-2 bg-gray-800 border border-gray-700 rounded-lg p-2 shadow-lg grid grid-cols-8 gap-1 w-64 z-20">
                        </div>
                </div>
                <button id="send-chat-btn" class="action-button bg-blue-600 hover:bg-blue-700 font-bold py-2 px-5 rounded-lg">Send</button>
            </div>
        </div>
    </main>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <script src="/static/main.js"></script>
</body>
</html>